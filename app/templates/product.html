{% extends "base.html" %}

{% block content %}
<br><br>

<h1>Product Search Results</h1>

<!-- CSS for indenting categories and tags -->
<style>
  .parent {
    margin-bottom: 20px;
  }

  .indent-1 {
    margin-left: 10px;
  }

  .indent-2 {
    margin-left: 20px;
  }

  .indent-3 {
    margin-left: 30px;
  }
</style>

<!-- JavaScript function to handle form submission for sorting and filtering -->
<script>
  function submitFilterForm() {
    document.getElementById("filterSortForm").action = "{{ url_for('products.get_products') }}";
    document.getElementById("filterSortForm").submit();
  }
</script>

<!-- Filter and Sorting Form -->
<div class="parent">
  <form METHOD="GET" id="filterSortForm">
    <div>
      <label for="keywords">Search:</label>
      <input type="text" name="keywords" value="{{ search_keywords }}" placeholder="Search products..." />
    </div>

    <br>
    <label>Categories:</label>
    <select name="category" onchange="submitFilterForm()">
      <option value="all">All Categories</option>
      <option value="Electronics" {% if selected_category == 'Electronics' %}selected{% endif %}>Electronics</option>
      <option value="Fashion" {% if selected_category == 'Fashion' %}selected{% endif %}>Fashion</option>
      <option value="Home and Garden" {% if selected_category == 'Home and Garden' %}selected{% endif %}>Home and Garden</option>
      <!-- Add other categories as needed -->
    </select>

    <div class="form-group d-flex mt-2">
      <label for="sortBy" class="mr-2">Sort by:</label>
      <select class="form-control mr-2" name="sort_by" id="sortBy" onchange="submitFilterForm()" style="width: 300px;">
        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
        <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Price</option>
        <option value="avg_rating" {% if sort_by == 'avg_rating' %}selected{% endif %}>Average Rating</option>
      </select>

      <label for="sortOrder" class="mr-2">Sort order:</label>
      <select class="form-control" name="sort_order" id="sortOrder" onchange="submitFilterForm()" style="width: 300px;">
        <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
        <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary mt-2">Apply Filters</button>
  </form>
</div>

<!-- Products Table -->
<table class="table table-hover table-bordered container">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Product ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
      <th scope="col">Description</th>
      <th scope="col">Category</th>
      <th scope="col">Image</th>
      <th scope="col">Rating</th>
      <th scope="col">Availability</th>
    </tr>
  </thead>
  <tbody>
    {% for product in products %}
    <tr onclick="window.location='{{ url_for('products.product_details', pid=product.product_ID) }}';" style="cursor:pointer;">
      <th scope="row">{{ product.product_ID }}</th>
      <td>{{ product.name }}</td>
      <td>${{ product.price }}</td>
      <td>{{ product.description }}</td>
      <td>{{ product.category }}</td>
      <td>
        <img src="{{ product.image }}" alt="{{ product.name }} Image" width="100" height="100">
      </td>
      <td>{{ '{:.1f}/5'.format(product.avg_rating) if product.avg_rating is not none else 'Not rated' }}</td>
      <td>
        <span class="{% if product.available %}text-success{% else %}text-danger{% endif %}">
          {% if product.available %}
            In Stock
          {% else %}
            Out of Stock
          {% endif %}
        </span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination">
    {% set total_pages = (total // per_page) + (1 if total % per_page > 0 else 0) %}
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('products.get_products', page=p, keywords=search_keywords, category=selected_category, sort_order=sort_order, sort_by=sort_by) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>

{% endblock %}